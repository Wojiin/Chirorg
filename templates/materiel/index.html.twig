{% extends 'base.html.twig' %}
{% block title %}Liste des matériels{% endblock %}
{# Bloc principal du contenu de la page #}
{% block body %}

{# Titre de la page #}
<h1>Matériels par spécialité</h1>

{# Lien vers la création d'un nouveau matériel #}
<a href="{{ path('materiel_new') }}">Créer un matériel</a>

{# Variables permettant de suivre la spécialité courante lors de la boucle #}
{% set currentSpecialiteId = null %}
{% set currentSpecialiteLabel = null %}

{# Parcourt tous les matériels, déjà triés par spécialité côté repository #}
{% for m in materiels %}

    {# Récupère l'id et le libellé de la spécialité
       Si aucune spécialité n'est associée, on utilise une valeur par défaut #}
    {% set specId = m.classer ? m.classer.id : 0 %}
    {% set specLabel = m.classer ? m.classer.intitule : 'Sans spécialité' %}

    {# Détecte un changement de spécialité #}
    {% if specId != currentSpecialiteId %}

        {# Ferme la liste précédente sauf pour le tout premier élément #}
        {% if not loop.first %}
            </ul>
        {% endif %}

        {# Affiche le titre de la nouvelle spécialité #}
        <h2>
            {% if m.classer %}
                <a href="{{ path('specialite_show', {id: m.classer.id}) }}">
                    {{ specLabel }}
                </a>
            {% else %}
                {{ specLabel }}
            {% endif %}
        </h2>

        {# Ouvre une nouvelle liste de matériels pour cette spécialité #}
        <ul>

        {# Met à jour la spécialité courante #}
        {% set currentSpecialiteId = specId %}
        {% set currentSpecialiteLabel = specLabel %}
    {% endif %}

    {# Affichage d'un matériel #}
    <li>
        {# Intitulé du matériel avec lien vers la page détail #}
        <strong>
            <a href="{{ path('materiel_show', {id: m.id}) }}">
                {{ m.intitule }}
            </a>
        </strong>
        — {{ m.type }} — {{ m.adresse }}

        {# Affiche les listes de matériel associées si elles existent #}
        {% if m.lister|length > 0 %}
            <br>
            <small>
                Listes :
                {% for l in m.lister %}
                    <a href="{{ path('liste_materiel_show', {id: l.id}) }}">
                        {{ l.intitule }}
                    </a>
                    {% if not loop.last %}, {% endif %}
                {% endfor %}
            </small>
        {% endif %}

        <br>

        {# Lien de modification du matériel #}
        <a href="{{ path('materiel_edit', {id: m.id}) }}">Modifier</a>
        |

        {# Formulaire de suppression sécurisé par token CSRF #}
        <form
            method="post"
            action="{{ path('materiel_delete', {id: m.id}) }}"
            style="display:inline"
        >
            <input
                type="hidden"
                name="_token"
                value="{{ csrf_token('delete' ~ m.id) }}"
            >
            <button type="submit">Supprimer</button>
        </form>
    </li>

    {# Ferme la dernière liste lorsque la boucle arrive au dernier élément #}
    {% if loop.last %}
        </ul>
    {% endif %}

{# Cas où aucun matériel n'existe #}
{% else %}
    <p>Aucun matériel enregistré.</p>
{% endfor %}

{% endblock %}
